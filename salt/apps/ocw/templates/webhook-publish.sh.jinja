#!/usr/bin/env bash

# Usage
#
# To run a normal publish, running only if code has changed:
#
# cd /opt/ocw
# ./webhook-publish.sh
#
# OR, to publish everything, no matter if any code has changed:
#
# cd /opt/ocw
# ./webhook-publish.sh full

LOG_DIR=/opt/ocw/logs
LOG_FILE=$LOG_DIR/webhook-publish.log
SOURCE_DATA_BUCKET={{ source_data_bucket }}
SOURCE_DATA_DIR=/opt/ocw/open-learning-course-data
OCW_HUGO_PROJECTS_PATH=/opt/ocw/ocw-hugo-projects
OCW_HUGO_THEMES_PATH=/opt/ocw/ocw-hugo-themes
WWW_HUGO_CONFIG_PATH=$OCW_HUGO_PROJECTS_PATH/ocw-www/config.yaml
COURSE_HUGO_CONFIG_PATH=$OCW_HUGO_PROJECTS_PATH/ocw-course/config.yaml
WWW_CONTENT_PATH=/opt/ocw/ocw-www
SITE_OUTPUT_DIR=$WWW_CONTENT_PATH/public/  # Should end in '/'
COURSE_CONTENT_PATH=/opt/ocw/ocw-to-hugo/private/output
WEBSITE_BUCKET={{ website_bucket }}
OCW_TO_HUGO_BUCKET={{ ocw_to_hugo_bucket }}
FASTLY_API_TOKEN={{ fastly_api_token }}
FASTLY_SERVICE_ID={{ fastly_service_id }}
OCW_WWW_GIT_REF={{ ocw_www_git_ref }}
OCW_HUGO_THEMES_GIT_REF={{ ocw_hugo_themes_git_ref }}
OCW_HUGO_PROJECTS_GIT_REF={{ ocw_hugo_projects_git_ref }}
COURSE_BASE_URL={{ course_base_url }}
OCW_STUDIO_BASE_URL={{ ocw_studio_base_url }}
OCW_IMPORT_STARTER_SLUG={{ ocw_import_starter_slug }}
STATIC_API_BASE_URL={{ static_api_base_url }}
GTM_ACCOUNT_ID={{ gtm_account_id }}
OCW_HASH_DIR=$WWW_CONTENT_PATH/public/static
OCW_WWW_HASH_PATH=$WWW_CONTENT_PATH/public/static/ocw-www-hash.txt
OCW_HUGO_THEMES_HASH_PATH=$WWW_CONTENT_PATH/public/static/ocw-hugo-themes-hash.txt
OCW_HUGO_PROJECTS_HASH_PATH=$WWW_CONTENT_PATH/public/static/ocw-hugo-projects-hash.txt
# lock_dir ensures that only one run of this script happens at once.
lock_dir=/tmp/webhook-publish-lock
# If retry_file is present, the script will run itself again to catch changes
# that came in during the period of the current run.
retry_file=/tmp/webhook-publish-retry

# Export those shell variables that must be environment variables for the
# processes we execute
export GTM_ACCOUNT_ID
export WWW_CONTENT_PATH=$WWW_CONTENT_PATH
export COURSE_CONTENT_PATH=$COURSE_CONTENT_PATH
export COURSE_HUGO_CONFIG_PATH=$COURSE_HUGO_CONFIG_PATH
export COURSE_BASE_URL=$COURSE_BASE_URL
export OCW_STUDIO_BASE_URL=$OCW_STUDIO_BASE_URL
export OCW_IMPORT_STARTER_SLUG=$OCW_IMPORT_STARTER_SLUG
export STATIC_API_BASE_URL=$STATIC_API_BASE_URL

# Optional script argument
script_option=$1

log_message() {
    echo `date +'%Y-%m-%d %H:%M:%S.%N'` $1 | tee -a ${LOG_FILE}
}

error_and_exit() {
    log_message $1
    rm -rf $lock_dir
    exit 1
}

# Do a git fetch and git reset to accomplish a `git pull` without failing if
# there was a change to the git history.
# Return 0 if the working copy was changed, 1 if it was not.
#
git_fetch_and_reset() {
    repo_name=$1
    git_ref=$2
    orig_commit=`git rev-parse HEAD`
    log_message "Pulling $repo_name"
    git fetch && git reset --hard origin/$git_ref \
        || error_and_exit "Can not pull $repo_name"
    git clean -f || error_and_exit "Unable to run git clean on directory for $repo_name"
    new_commit=`git rev-parse HEAD`
    log_message "$orig_commit -> $new_commit"
    if [ "$orig_commit" != "$new_commit" ]; then
        log_message "... Pulled new commit"
        return 0
    else
        log_message "... No new commit"
        return 1
    fi
}

clear_directory() {
    dir=$1
    log_message "Clearing $dir"
    rm -rf $dir
    if [ $? -ne 0 ]; then
        error_and_exit "Could not clear $dir"
    fi
}

# Manage locking directory and retry file

mkdir $lock_dir
if [ $? -ne 0 ]; then
    echo "Can not acquire lock. Another run in-progress?" >&2
    touch $retry_file
    exit 1
fi

if [ -e $retry_file ]; then
    log_message "This is a re-run."
    rm $retry_file
fi


# Pull source data

log_message "Pulling source data"
aws s3 sync s3://$SOURCE_DATA_BUCKET/ $SOURCE_DATA_DIR/ --delete \
    --only-show-errors
if [ $? -ne 0 ]; then
    error_and_exit "Failed to pull source data"
fi


# Pull ocw-www
cd $WWW_CONTENT_PATH || error_and_exit "Can not cd to ocw-www"
git_fetch_and_reset ocw-www $OCW_WWW_GIT_REF
ocw_www_changed=$?

# Pull ocw-hugo-themes
cd $OCW_HUGO_THEMES_PATH || error_and_exit "Can not cd to ocw-hugo-themes"
git_fetch_and_reset ocw-hugo-themes $OCW_HUGO_THEMES_GIT_REF
ocw_hugo_themes_changed=$?

# Pull ocw-hugo-projects
cd $OCW_HUGO_PROJECTS_PATH || error_and_exit "Can not cd to ocw-hugo-projects"
git_fetch_and_reset ocw-hugo-projects $OCW_HUGO_PROJECTS_GIT_REF
ocw_hugo_projects_changed=$?

# Continue if there were changes, or if we want a 'full' run regardless of
# changes.
if [ "$script_option" != "full" ]; then
    if [ $ocw_www_changed -eq 0 ] || [ $ocw_hugo_themes_changed -eq 0 ]; then

        log_message "Pulled new commit; continuing with publish."

    else

        log_message "No new commits; stopping."
        rmdir $lock_dir
        exit 0
    fi
fi

# Install packages for ocw-hugo-themes (this should include ocw-to-hugo)
cd $OCW_HUGO_THEMES_PATH
log_message "Doing yarn install of dependencies for ocw-hugo-themes"
yarn install --pure-lockfile >> $LOG_DIR/ocw-hugo-themes-install.log 2>&1 \
    || error_and_exit "Can't install dependencies for ocw-hugo-themes"

# Generate ocw-hugo-themes git hash
npm run build:githash || error_and_exit "Unable to create hash file"

# Build ocw-www using ocw-hugo-themes
npm run build -- $WWW_CONTENT_PATH $WWW_HUGO_CONFIG_PATH  || error_and_exit "Unable to build ocw-www site"

# Make sure output directory is clear and move built ocw-www there
mkdir -p $SITE_OUTPUT_DIR
clear_directory $SITE_OUTPUT_DIR
mv $WWW_CONTENT_PATH/dist/* $SITE_OUTPUT_DIR

# Run ocw-to-hugo
cd ./node_modules/@mitodl/ocw-to-hugo

clear_directory ./node_modules

log_message "Doing yarn install of ocw-to-hugo"
yarn install --pure-lockfile >> $LOG_DIR/ocw-to-hugo-install.log 2>&1 \
    || error_and_exit "Can not install ocw-to-hugo"

log_message "Running ocw-to-hugo"
node . -i $SOURCE_DATA_DIR -o $COURSE_CONTENT_PATH \
    --strips3 --staticPrefix /coursemedia --rm >> $LOG_DIR/ocw-to-hugo.log 2>&1
if [ $? -ne 0 ]; then
    error_and_exit "Failed to run ocw-to-hugo. See $LOG_DIR/ocw-to-hugo.log"
fi


# Run course builds with ocw-hugo-themes
echo "Running hugo on courses in $COURSE_CONTENT_PATH..."
cd /opt/ocw/ocw-hugo-themes
./package_scripts/build_all_courses.sh >> $LOG_DIR/course-builds.log 2>&1
if [ $? -ne 0 ]; then
    error_and_exit "Failed to run course builds. See $LOG_DIR/course-builds.log"
fi

# Write commit hash files

log_message "Writing commit hash files"

mkdir $OCW_HASH_DIR \
&& cd $WWW_CONTENT_PATH \
&& git rev-parse HEAD > $OCW_WWW_HASH_PATH \
&& cd $OCW_HUGO_THEMES_PATH \
&& git rev-parse HEAD > $OCW_HUGO_THEMES_HASH_PATH \
&& cd $OCW_HUGO_PROJECTS_PATH \
&& git rev-parse HEAD > $OCW_HUGO_PROJECTS_HASH_PATH

if [ $? -ne 0 ]; then
    error_and_exit "Failed to write commit hash files"
fi


# Sync HTML to S3 bucket

log_message "Syncing to S3 bucket ($WEBSITE_BUCKET)"
# a little double-check to make sure the source directory ends in a slash, to
# prevent the site from getting copied into a subdirectory ...
echo "$SITE_OUTPUT_DIR" | grep -q '/$'
if [ $? -ne 0 ]; then
    log_message "WARNING: appending '/' to $SITE_OUTPUT_DIR"
    SITE_OUTPUT_DIR=$SITE_OUTPUT_DIR/
fi
aws s3 sync $SITE_OUTPUT_DIR s3://$WEBSITE_BUCKET/ \
    --delete --only-show-errors >> $LOG_DIR/website-sync.log 2>&1
if [ $? -ne 0 ]; then
    error_and_exit "Failed to sync to S3 bucket. See $LOG_DIR/website-sync.log"
fi


# Clear CDN cache

log_message "Clearing Fastly cache"
curl -f -X POST -H "Fastly-Key: $FASTLY_API_TOKEN" \
    https://api.fastly.com/service/$FASTLY_SERVICE_ID/purge_all
if [ $? -ne 0 ]; then
    log_message "WARNING: Failed to clear Fastly cache!"
fi

# Sync ocw-to-hugo output to S3

log_message "Syncing ocw-to-hugo output to S3"
aws s3 sync $COURSE_CONTENT_PATH/ s3://$OCW_TO_HUGO_BUCKET/ \
    --delete --only-show-errors >> $LOG_DIR/ocw-to-hugo-output-sync.log 2>&1
if [ $? -ne 0 ]; then
    error_and_exit "Failed to sync to S3 bucket. See $LOG_DIR/ocw-to-hugo-output-sync.log"
fi


log_message "Done"

# Clean up

if [ -e $retry_file ]; then
    log_message "$retry_file exists. Removing $lock_dir and re-running ..."
    rmdir $lock_dir
    exec /opt/ocw/webhook-publish.sh
else
    rmdir $lock_dir
fi

exit 0
